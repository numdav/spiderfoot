name: Baseline Test - SpiderFoot

on:
  push:
    branches: [ "fix-vuln-numda" ]
  pull_request:
  workflow_dispatch:

jobs:
  #JOB 1: Test Web - CLI - Module
  runtest:
    name: runtest
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:

      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run SpiderFoot
        run: |
           python3 ./sf.py -l 127.0.0.1:5001 &
           sleep 10
           if curl -I http://127.0.0.1:5001; then
             echo "SUCCESS: App is running!"
           else
             echo "WARNING: App failed to start"
           fi

      - name: Run SFCLI
        run: |
           echo "Verifying CLI functionality..."
           python3 sfcli.py --help
           python3 sfcli.py -s http://127.0.0.1:5001 -d

      - name: Security Verification - sfp_citadel
        # Questo test deve FALLIRE se trova la vulnerabilità.
        continue-on-error: true
        run: |
          cat <<EOF > test_citadel_vuln.py
          import sys
          from unittest.mock import MagicMock
          
          sys.modules['spiderfoot'] = MagicMock()
          
          try:
              print("--- INIZIO ANALISI DINAMICA SFP_CITADEL ---")
              from modules.sfp_citadel import sfp_citadel
              plugin = sfp_citadel()
              plugin.opts = {'api_key': '', 'timeout': 30, '_useragent': 'Test'}
              plugin.sf = MagicMock()

              def spy_fetchUrl(url, postData=None, **kwargs):
                  print(f"DEBUG: Chiamata HTTP tentata verso: {url}")

                  VULN_KEY = "3edfb5603418f101926c64ca5dd0e409"

                  if postData and VULN_KEY in str(postData):
                      print("\n[!!!] CRITICAL ALERT [!!!]")
                      print(f"Il modulo ha inviato la chiave: {VULN_KEY}")
                      print("DIAGNOSI: Il modulo FUNZIONA ma è VULNERABILE (Secret Exposure).")
                      sys.exit(1)
                  else:
                      print("INFO: Nessuna chiave hardcoded rilevata nella chiamata.")
                      return {'content': None, 'code': '200'}
              
              plugin.sf.fetchUrl = spy_fetchUrl
              print("Esecuzione queryMail()...")
              plugin.queryEmail("test@test.com")

              print("RISULTATO: Il modulo ha girato senza esporre il secret (o non ha fatto chiamate).")
              
          except SystemExit as e:
              sys.exit(e.code)
          except Exception as e:
              print(f"Errore imprevisto: {e}")
          EOF
          
          echo "Running Citadel Verification on MASTER code..."
          python3 test_citadel_vuln.py

  #JOB 2: Test Docker
  docker-test:
    name: Docker build test
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:

      - uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0

      - name: Attempt Docker Build
        run: |
          docker build . -t spiderfoot:baseline
